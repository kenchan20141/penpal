<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <title>創作社——以文會友</title>
    <!-- 添加到主畫面設定 -->
    <meta name="application-name" content="以文會友">
    <meta name="apple-mobile-web-app-title" content="以文會友">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.ibb.co/fYPQnzLS/image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Android 圖示 -->
    <link rel="icon" sizes="192x192" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="icon" sizes="144x144" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="icon" sizes="96x96" href="https://i.ibb.co/fYPQnzLS/image.png">
    <!-- iOS 圖示 -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://i.ibb.co/fYPQnzLS/image.png">
    <style>
        /* --- 全局與侘寂風設計 (新色調) --- */
        :root {
            --background-color: #f4f4f5; /* 更柔和的灰白背景 */
            --text-color: #333;
            --primary-color: #607D8B; /* 低調的灰藍色 */
            --primary-color-rgb: 96, 125, 139; /* 用於box-shadow的RGB值 */
            --primary-color-hover: #546E7A; /* 按鈕懸停色 */
            --border-color: #e0e0e0; /* 更淺的邊框 */
            --input-bg-color: #fff;
            --message-bg-color: #eceff1; /* 訊息氣泡背景 */
            --font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            --danger-color: #c95c58;
            --danger-color-hover: #b04b47;
            --subtle-text-color: #777; /* 用於預覽文字 */
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            background-image: url('背景圖片.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        /* --- (新增) 密碼驗證畫面 --- */
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            padding: 15px;
        }
        .password-box {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        .password-box h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .password-box .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }
        #site-password-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #site-password-submit {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #site-password-submit:hover {
            background-color: var(--primary-color-hover);
        }
        #site-password-submit:disabled {
            background-color: #90a4ae;
            cursor: not-allowed;
        }
        #password-error-message {
            color: #d9534f;
            margin-top: 15px;
            height: 20px;
            font-size: 14px;
        }
        /* --- 主容器 --- */
        .container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            max-height: 900px;
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; /* [新增] 為配對面板定位 */
        }
        /* --- 登入畫面 --- */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px 40px;
            text-align: center;
            overflow-y: auto;
        }
        #login-screen h1 {
            font-size: 28px;
            font-weight: 500;
            margin-bottom: 25px;
            color: var(--text-color);
        }
        #room-list-container {
            width: 100%;
            max-width: 380px;
            margin-bottom: 25px;
            text-align: left;
        }
        #room-list-container h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        #room-list {
            list-style-type: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #room-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        #room-list li:last-child {
            border-bottom: none;
        }
        #room-list li:hover {
            background-color: #f9f9f9;
        }
        .room-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            margin-right: 10px;
        }
        .room-name {
            font-weight: 600;
            font-size: 17px;
            color: #263238;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .last-message-preview {
            font-size: 14px;
            color: var(--subtle-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-message-sender {
            font-weight: 600;
            color: var(--primary-color);
        }
        .no-message-info {
            font-style: italic;
            font-size: 14px;
            color: #999;
        }
        .delete-room-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 15px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        #room-list li:hover .delete-room-btn {
            opacity: 0.8;
        }
        .delete-room-btn:hover {
            opacity: 1;
            background-color: var(--danger-color-hover);
        }
        #no-rooms-message {
            color: #999;
            font-size: 14px;
            padding: 20px;
            text-align: center;
            cursor: default;
        }
        #no-rooms-message:hover {
            background-color: transparent;
        }
        .login-divider {
            margin: 15px 0;
            font-size: 14px;
            color: #999;
        }
        .input-group {
            width: 100%;
            max-width: 380px;
            margin-bottom: 15px;
        }
        .input-field {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg-color);
            transition: border-color 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .btn {
            padding: 12px 20px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
            width: 100%;
            max-width: 380px;
        }
        .btn:hover {
            background-color: var(--primary-color-hover);
        }
        .btn:disabled {
            background-color: #90a4ae;
            cursor: not-allowed;
        }
        #error-message {
            color: #d9534f;
            margin-top: 15px;
            height: 20px;
            font-size: 14px;
        }

        /* --- [新增] 隨機配對功能樣式 --- */
        #pairing-toggle-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: 1px solid transparent;
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            z-index: 110;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #pairing-toggle-button:hover {
            background-color: rgba(0,0,0,0.05);
        }
        #pairing-toggle-button.active {
            border-color: var(--border-color);
            background-color: rgba(0,0,0,0.02);
        }
        #pairing-toggle-button svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
            opacity: 0.7;
        }
        #pairing-panel {
            display: none;
            position: absolute;
            top: 65px;
            right: 15px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 15px;
            z-index: 109;
            width: 220px;
            flex-direction: column;
            gap: 10px;
        }
        .pairing-button {
            font-family: var(--font-family);
            width: 100%;
            padding: 10px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .pairing-button:hover {
            background-color: #f9f9f9;
            border-color: var(--primary-color);
        }
        .pairing-button.lit {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.4);
        }
        #pairing-status {
            font-size: 13px;
            color: var(--subtle-text-color);
            text-align: center;
            margin-top: 5px;
        }


        /* --- 聊天室畫面 --- */
        #chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fcfcfc;
            flex-shrink: 0;
            position: sticky; 
            top: 0; 
            z-index: 10; 
            min-height: 60px; 
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        #chat-room-name {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #chat-room-name[contenteditable="true"] {
            outline: none;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 2px;
        }
        #edit-room-name-button,
        #member-info-button,
        #user-profile-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s; 
            color: var(--text-color); 
        }
        #edit-room-name-button:hover,
        #member-info-button:hover,
        #user-profile-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        #edit-room-name-button svg,
        #member-info-button svg,
        #user-profile-button svg {
            width: 20px;
            height: 20px;
        }
        #logout-button {
            font-size: 14px;
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }
        #logout-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: url('對話背景圖.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        .message-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sender-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            margin-left: 5px;
            cursor: pointer; 
        }
        .sender-name:hover {
            text-decoration: underline; 
        }
        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 12px;
            background-color: rgba(236, 239, 241, 0.9);
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message .timestamp {
            font-size: 11px;
            color: #999;
            display: block;
            margin-top: 5px;
            text-align: right;
            opacity: 0.7;
        }
        .message-group.own-message {
            align-items: flex-end;
        }
        .message-group.own-message .sender-name {
            display: none;
        }
        .message-group.own-message .message {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .message-group.own-message .message .timestamp {
            color: #e0e0e0;
            opacity: 0.8;
        }
        .chat-input {
            display: flex;
            align-items: center;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #fcfcfc;
            flex-shrink: 0;
        }
        .chat-input #message-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 16px;
        }
        .chat-input #message-input:focus {
             outline: none;
            border-color: var(--primary-color);
        }
        #send-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s; 
        }
        #send-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1); 
        }
        #send-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
        }

        /* --- [新增] 新留言分隔線樣式 --- */
        .new-messages-separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 5px;
            color: var(--subtle-text-color);
        }
        .new-messages-separator::before,
        .new-messages-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        .new-messages-separator span {
            padding: 0 15px;
            font-size: 13px;
            font-family: var(--font-family);
        }
        
        /* --- 成員列表彈出視窗 --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--input-bg-color);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-color);
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s; 
        }
        .close:hover,
        .close:focus {
            color: black;
            transform: scale(1.1); 
        }
        .member-list {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .member-list li {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; 
        }
        .member-list li:hover {
            background-color: #f0f0f0;
        }
        .member-list li:last-child {
            border-bottom: none;
        }
        .member-count {
            font-size: 14px;
            color: var(--subtle-text-color);
            margin-top: 10px;
            text-align: right;
        }
        /* --- 個人資料彈出視窗 (新增) --- */
        #profileModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .profile-modal-content {
            background-color: var(--input-bg-color);
            margin: 15% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .profile-modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-color);
        }
        .profile-form-group {
            margin-bottom: 15px;
        }
        .profile-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }
        .profile-input-field {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg-color);
            transition: border-color 0.3s;
        }
        .profile-input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .profile-viewer .profile-input-field {
            background-color: #f9f9f9;
            cursor: default;
        }
        .profile-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .profile-btn-submit {
            font-family: var(--font-family);
            font-size: 15px;
            padding: 10px 30px;
            border-radius: 25px;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }
        .profile-btn-submit:hover {
            background-color: var(--primary-color);
            color: #fff;
            box-shadow: 0 2px 8px rgba(96, 125, 139, 0.2);
        }

        @media (max-width: 600px) {
            html, body {
                overflow: hidden; /* 防止整個頁面滾動 */
            }
            body { padding: 0; }
            .container {
                height: 100%; /* 使用 100% 以獲得更好的兼容性 */
                max-height: 100%;
                border-radius: 0;
                border: none;
                padding-top: env(safe-area-inset-top); /* 尊重頂部安全區域（瀏海） */
            }
            #login-screen { padding: 20px; }
            .modal-content,
            .profile-modal-content {
                width: 95%;
                margin: 20% auto;
            }
            .password-box {
                padding: 25px;
            }
            .chat-header {
                padding: 15px 15px 10px 15px; /* 增加頂部內邊距 */
            }
            .header-left, .header-right {
                gap: 8px;
            }
            .chat-messages {
                padding: 10px;
            }
            .chat-input {
                 padding-bottom: env(safe-area-inset-bottom); /* 尊重底部安全區域（Home Indicator） */
            }
        }
    </style>
</head>
<body>
    <!-- 密碼驗證畫面 -->
    <div id="password-overlay">
        <div class="password-box">
            <h1>請輸入通行密碼</h1>
            <p class="subtitle">此為私人創作空間，請輸入密碼以繼續。</p>
            <input type="password" id="site-password-input" class="input-field" placeholder="通行密碼...">
            <button id="site-password-submit">進入</button>
            <p id="password-error-message"></p>
        </div>
    </div>
    <!-- 主容器 -->
    <div class="container" style="display: none;">

        <!-- [新增] 隨機配對按鈕與面板 -->
        <button id="pairing-toggle-button" title="隨機配對">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 18l-4-4 4-4 1.41 1.41L18.83 14l2.58 2.59L20 18zm-8.71-2.29L3 7.41 4.41 6l8.29 8.29-1.41 1.42zM12.5 10c.89 0 1.77.2 2.55.59l1.52-1.52C15.34 8.5 14 8 12.5 8S9.66 8.5 8.43 9.07l1.52 1.52c.78-.39 1.66-.59 2.55-.59zM4.48 10.63l1.52 1.52c-.18.44-.29.91-.3 1.38H2v-1.5h3.19c.01-.16.03-.32.05-.47L4.48 10.63zM22 13.5h-3.19c-.01.16-.03.32-.05.47l.76.76c.18-.44.29-.91.3-1.38H22v-1.5zm-8.91 3.2l1.52 1.52c1.23-.57 2.34-1.49 3.2-2.65l-1.52-1.52c-.65.91-1.53 1.61-2.55 2.06z"/></svg>
        </button>
        <div id="pairing-panel">
            <button id="pair-two-button" class="pairing-button">兩人對談</button>
            <button id="pair-three-button" class="pairing-button">三人圍爐</button>
            <div id="pairing-status"></div>
        </div>

        <!-- 登入畫面 -->
        <div id="login-screen">
            <h1>創作社——以文會友</h1>
            <div id="room-list-container">
                <h2>我的文友群組</h2>
                <ul id="room-list">
                    <!-- Javascript 會動態填入這裡 -->
                </ul>
            </div>
            <div class="login-divider">或加入/建立新的群組</div>
            <div class="input-group">
                <input type="text" id="user-name" class="input-field" placeholder="您的稱呼..." autocomplete="off">
            </div>
            <div class="input-group">
                <input type="password" id="room-password" class="input-field" placeholder="交流密碼..." autocomplete="off">
            </div>
            <button id="enter-chat-button" class="btn">進入</button>
            <p id="error-message"></p>
        </div>
        <!-- 聊天室畫面 -->
        <div id="chat-screen">
            <header class="chat-header">
                <div class="header-left">
                    <h2 id="chat-room-name" spellcheck="false">交流空間</h2>
                    <button id="edit-room-name-button" title="修訂群組名稱">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="header-right">
                    <button id="member-info-button" title="檢視群組成員">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                        </svg>
                    </button>
                    <button id="user-profile-button" title="編輯個人資料">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <a id="logout-button" title="關閉">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </header>
            <div id="chat-messages" class="chat-messages"></div>
            <form id="message-form" class="chat-input">
                <input type="text" id="message-input" class="input-field" placeholder="分享你的閱讀心得..." autocomplete="off">
                <button type="submit" id="send-button" title="傳送">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </form>
        </div>
    </div>
    <!-- 成員列表彈出視窗 -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>群組成員</h2>
                <span class="close">&times;</span>
            </div>
            <ul id="member-list" class="member-list">
                <!-- 成員列表將動態填入 -->
            </ul>
            <div id="member-count" class="member-count">
                <!-- 人數將動態填入 -->
            </div>
        </div>
    </div>
    <!-- 個人資料彈出視窗 -->
    <div id="profileModal" class="modal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2 id="profile-modal-title">個人資料</h2>
                <span class="close close-profile">&times;</span>
            </div>
            <form id="profile-form">
                <div class="profile-form-group">
                    <label for="profile-name" class="profile-label">姓名</label>
                    <input type="text" id="profile-name" class="profile-input-field" readonly>
                </div>
                <div class="profile-form-group">
                    <label for="profile-intro" class="profile-label">自我介紹</label>
                    <textarea id="profile-intro" class="profile-input-field" rows="3"></textarea>
                </div>
                <div class="profile-form-group">
                    <label for="profile-book" class="profile-label">正在閱讀</label>
                    <input type="text" id="profile-book" class="profile-input-field">
                </div>
                <div class="profile-buttons">
                    <button type="button" class="profile-btn-submit" id="save-profile-btn">儲存設定</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // --- Firebase 配置 ---
        let database, auth; // 在全域宣告變數

        // --- DOM 元素獲取 ---
        const passwordOverlay = document.getElementById('password-overlay');
        const sitePasswordInput = document.getElementById('site-password-input');
        const sitePasswordSubmit = document.getElementById('site-password-submit');
        const passwordErrorMessage = document.getElementById('password-error-message');
        const mainContainer = document.querySelector('.container');
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const userNameInput = document.getElementById('user-name');
        const roomPasswordInput = document.getElementById('room-password');
        const enterChatButton = document.getElementById('enter-chat-button');
        const errorMessage = document.getElementById('error-message');
        const logoutButton = document.getElementById('logout-button');
        const chatHeaderName = document.getElementById('chat-room-name');
        const editRoomNameButton = document.getElementById('edit-room-name-button');
        const memberInfoButton = document.getElementById('member-info-button');
        const userProfileButton = document.getElementById('user-profile-button');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const roomList = document.getElementById('room-list');
        const memberModal = document.getElementById('memberModal');
        const closeModalBtn = document.querySelector('.close');
        const memberListElement = document.getElementById('member-list');
        const memberCountElement = document.getElementById('member-count');
        const profileModal = document.getElementById('profileModal');
        const profileModalTitle = document.getElementById('profile-modal-title');
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileIntroInput = document.getElementById('profile-intro');
        const profileBookInput = document.getElementById('profile-book');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const closeProfileBtns = document.querySelectorAll('.close-profile');
        // --- [新增] 配對功能 DOM 元素 ---
        const pairingToggleButton = document.getElementById('pairing-toggle-button');
        const pairingPanel = document.getElementById('pairing-panel');
        const pairTwoButton = document.getElementById('pair-two-button');
        const pairThreeButton = document.getElementById('pair-three-button');
        const pairingStatus = document.getElementById('pairing-status');

        // --- 全局狀態 ---
        let currentRoomId = null;
        let currentUserName = null;
        let currentUserId = null;
        let messagesRef = null;
        let membersRef = null;
        let savedRooms = [];
        let globalListeners = {};
        let memberListeners = {};
        let pairingListener = null; // [新增] 用於配對的監聽器
        let isEditingRoomName = false;
        let originalRoomName = '';
        let hasCheckedProfile = false; // [新增] 用於檢查是否已提示過編輯個人資料
        const USER_COLORS = ['#e57373', '#ba68c8', '#7986cb', '#4fc3f7', '#4db6ac', '#aed581', '#ffb74d', '#ff8a65', '#90a4ae', '#a1887f'];
        function getColorForUserId(userId) {
            let hash = 0;
            for (let i = 0; i < userId.length; i++) hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            return USER_COLORS[Math.abs(hash % USER_COLORS.length)];
        }
        
        // --- 群組清單管理 ---
        function saveRoomsToStorage() {
            const roomsToSave = savedRooms.map(({ id, name, userName }) => ({ id, name, userName }));
            localStorage.setItem('penpal-rooms', JSON.stringify(roomsToSave));
        }
        function loadRoomsFromStorage() {
            const roomsJSON = localStorage.getItem('penpal-rooms');
            savedRooms = roomsJSON ? JSON.parse(roomsJSON) : [];
        }
        function renderRoomList() {
            roomList.innerHTML = '';
            if (savedRooms.length === 0) {
                roomList.innerHTML = '<li id="no-rooms-message">尚未儲存任何群組</li>';
                return;
            }
            // [新增] 按時間戳排序，最新的在最前面
            savedRooms.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            savedRooms.forEach(room => {
                const li = document.createElement('li');
                li.setAttribute('data-room-id', room.id);
                const roomInfoDiv = document.createElement('div');
                roomInfoDiv.className = 'room-info';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'room-name';
                nameSpan.textContent = room.name;
                roomInfoDiv.appendChild(nameSpan);
                const previewDiv = document.createElement('div');
                if (room.lastMessageText) {
                    previewDiv.className = 'last-message-preview';
                    const senderSpan = document.createElement('span');
                    senderSpan.className = 'last-message-sender';
                    senderSpan.textContent = `${room.lastMessageSender}: `;
                    const textSpan = document.createElement('span');
                    textSpan.className = 'last-message-text';
                    textSpan.textContent = room.lastMessageText;
                    previewDiv.appendChild(senderSpan);
                    previewDiv.appendChild(textSpan);
                } else {
                    previewDiv.className = 'no-message-info';
                    previewDiv.textContent = '尚無訊息';
                }
                roomInfoDiv.appendChild(previewDiv);
                li.appendChild(roomInfoDiv);
                li.addEventListener('click', () => {
                    const clickedRoom = savedRooms.find(r => r.id === room.id);
                    if (!clickedRoom) return;
                    if (clickedRoom.userName) {
                        userNameInput.value = clickedRoom.userName;
                    }
                    roomPasswordInput.value = clickedRoom.id;
                    handleLoginAttempt();
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-room-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = '從列表中移除';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`確定要從列表中移除「${room.name}」嗎？\n此操作亦會將您從該群組成員名單中移除。`)) {
                        const userNameToRemove = localStorage.getItem('penpal-userName');
                        if (userNameToRemove) {
                            removeMemberFromRoom(room.id, userNameToRemove);
                        }
                        // [新增] 同時從 Firebase 的 userRooms 中移除
                        if (currentUserId) {
                             database.ref(`userRooms/${currentUserId}/${room.id}`).remove();
                        }
                        detachSingleGlobalListener(room.id);
                        detachSingleMemberListener(room.id);
                        savedRooms = savedRooms.filter(r => r.id !== room.id);
                        saveRoomsToStorage();
                        renderRoomList();
                    }
                });
                li.appendChild(deleteBtn);
                roomList.appendChild(li);
            });
        }
        function addOrUpdateRoom(roomId, roomName, userName, isNew = false) {
            let existingRoom = savedRooms.find(r => r.id === roomId);
            if (existingRoom) {
                existingRoom.name = roomName;
                existingRoom.userName = userName;
            } else {
                existingRoom = { id: roomId, name: roomName, userName: userName, timestamp: Date.now() };
                savedRooms.push(existingRoom);
                 if (isNew) {
                    // [新增] 如果是新配對的群組，短暫高亮
                    setTimeout(() => {
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            roomElement.style.transition = 'background-color 0.5s ease-in-out';
                            roomElement.style.backgroundColor = 'rgba(96, 125, 139, 0.1)';
                            setTimeout(() => { roomElement.style.backgroundColor = ''; }, 2000);
                        }
                    }, 100);
                }
            }
            saveRoomsToStorage();
            listenToSingleRoom(existingRoom);
            renderRoomList();
        }
        
        const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
        const saveIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
        function handleRoomNameKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                chatHeaderName.blur();
            } else if (event.key === 'Escape') {
                isEditingRoomName = false;
                chatHeaderName.blur();
            }
        }
        function toggleRoomNameEdit() {
            if (isEditingRoomName) {
                const newName = chatHeaderName.textContent.trim();
                chatHeaderName.removeEventListener('keydown', handleRoomNameKeydown);
                chatHeaderName.contentEditable = false;
                editRoomNameButton.innerHTML = editIconSVG;
                editRoomNameButton.title = '修訂群組名稱';
                
                if (newName && newName !== originalRoomName) {
                    addOrUpdateRoom(currentRoomId, newName, currentUserName);
                    // [新增] 更新 Firebase 中的房間名稱
                    database.ref(`chatrooms/${currentRoomId}/name`).set(newName);
                    chatHeaderName.textContent = newName;
                } else {
                    chatHeaderName.textContent = originalRoomName;
                }
                isEditingRoomName = false;

            } else {
                isEditingRoomName = true;
                originalRoomName = chatHeaderName.textContent;
                chatHeaderName.contentEditable = true;
                chatHeaderName.focus();
                document.execCommand('selectAll', false, null);
                editRoomNameButton.innerHTML = saveIconSVG;
                editRoomNameButton.title = '儲存名稱';
                
                chatHeaderName.addEventListener('keydown', handleRoomNameKeydown);
                chatHeaderName.addEventListener('blur', () => {
                    if (!isEditingRoomName) {
                        chatHeaderName.textContent = originalRoomName;
                    }
                    toggleRoomNameEdit();
                }, { once: true });
            }
        }
        
        function displayMessage({ name, text, timestamp, userId }, messageId) {
            const messageGroup = document.createElement('div');
            messageGroup.id = `msg-${messageId}`;
            messageGroup.classList.add('message-group');
            if (userId === currentUserId) messageGroup.classList.add('own-message');
            const senderName = document.createElement('div');
            senderName.classList.add('sender-name');
            senderName.textContent = name || '匿名';
            senderName.style.color = getColorForUserId(userId);
            senderName.setAttribute('data-user-id', userId); 
            senderName.addEventListener('click', (e) => {
                e.stopPropagation();
                if (userId !== currentUserId) {
                    viewOtherUserProfile(userId, name);
                }
            });

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            const textNode = document.createElement('span');
            textNode.textContent = text;
            const timeNode = document.createElement('span');
            timeNode.classList.add('timestamp');
            timeNode.textContent = new Date(timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            messageElement.appendChild(textNode);
            messageElement.appendChild(timeNode);
            messageGroup.appendChild(senderName);
            messageGroup.appendChild(messageElement);
            chatMessages.appendChild(messageGroup);
            return messageGroup;
        }
        
        async function listenForMessages() {
            if (messagesRef) {
                chatMessages.innerHTML = '';
                const lastReadMessageId = localStorage.getItem(`lastReadMsg_${currentRoomId}`);
                let firstUnreadElement = null;
                let lastReadMessageFound = !lastReadMessageId; 

                // [新增] 檢查是否需要提示編輯個人資料
                if (!hasCheckedProfile) {
                    const profileRef = database.ref(`chatrooms/${currentRoomId}/profiles/${currentUserId}`);
                    const snapshot = await profileRef.once('value');
                    if (!snapshot.exists()) {
                         setTimeout(() => openProfileModal(true), 500);
                    }
                    hasCheckedProfile = true;
                }


                const scrollToBottom = () => {
                    setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 0);
                };

                const scrollToFirstUnread = () => {
                    if (firstUnreadElement) {
                        const separator = document.createElement('div');
                        separator.className = 'new-messages-separator';
                        separator.innerHTML = '<span>新留言</span>';
                        chatMessages.insertBefore(separator, firstUnreadElement);
                        separator.scrollIntoView({ behavior: 'auto', block: 'center' });
                        firstUnreadElement.style.transition = 'background-color 0.5s';
                        firstUnreadElement.style.backgroundColor = 'rgba(96, 125, 139, 0.1)';
                        setTimeout(() => {
                            firstUnreadElement.style.backgroundColor = '';
                        }, 2000);
                    } else {
                        scrollToBottom();
                    }
                };
                
                messagesRef.on('child_added', snapshot => {
                    const message = snapshot.val();
                    const messageId = snapshot.key;
                    if(message) {
                        const messageElement = displayMessage(message, messageId);

                        if (!lastReadMessageFound) {
                            if (messageId === lastReadMessageId) {
                                lastReadMessageFound = true; 
                            }
                        } else if (!firstUnreadElement) {
                            firstUnreadElement = messageElement;
                        }

                        const isNearBottom = chatMessages.scrollHeight - chatMessages.clientHeight - chatMessages.scrollTop < 100;
                        if (isNearBottom) {
                            scrollToBottom();
                        }
                    }
                });

                messagesRef.once('value', () => {
                    setTimeout(scrollToFirstUnread, 100);
                });
            }
        }
        function stopListeningForMessages() {
            if (messagesRef) messagesRef.off();
        }
        function sendMessage(event) {
            event.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText && messagesRef && currentUserName && currentUserId) {
                const messageData = {
                    name: currentUserName,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userId: currentUserId
                };
                messagesRef.push(messageData).catch(error => {
                     console.error("訊息發送失敗:", error);
                     alert("無法發送訊息，可能是權限問題或網絡連線中斷。");
                });
                messageInput.value = '';
            }
        }
        function listenForMemberList() {
            if (membersRef) {
                 memberListElement.innerHTML = '';
                 if (memberListeners[currentRoomId]) {
                     membersRef.off('value', memberListeners[currentRoomId]);
                 }
                 memberListeners[currentRoomId] = function(snapshot) {
                     const members = snapshot.val();
                     memberListElement.innerHTML = '';
                     if (members) {
                         const memberNames = Object.keys(members);
                         memberNames.forEach(name => {
                             const li = document.createElement('li');
                             li.textContent = name;
                             li.addEventListener('click', (e) => {
                                 e.stopPropagation();
                                 const userId = members[name];
                                 if (userId !== currentUserId) {
                                     viewOtherUserProfile(userId, name);
                                 }
                             });
                             memberListElement.appendChild(li);
                         });
                         memberCountElement.textContent = `總人數: ${memberNames.length}`;
                     } else {
                         memberCountElement.textContent = `總人數: 0`;
                     }
                 };
                 membersRef.on('value', memberListeners[currentRoomId]);
            }
        }
        function stopListeningForMemberList() {
            if (membersRef && memberListeners[currentRoomId]) {
                membersRef.off('value', memberListeners[currentRoomId]);
                delete memberListeners[currentRoomId];
            }
        }
        function addMemberToRoom(roomId, userName, userId) {
            const memberRef = database.ref('chatrooms/' + roomId + '/members/' + userName);
            memberRef.set(userId).catch(error => {
                console.error("加入成員列表失敗:", error);
            });
        }
        function removeMemberFromRoom(roomId, userName) {
            const memberRef = database.ref('chatrooms/' + roomId + '/members/' + userName);
            memberRef.remove().catch(error => {
                console.error("移除成員失敗:", error);
            });
        }
        function openMemberModal() { memberModal.style.display = "block"; }
        function closeMemberModal() { memberModal.style.display = "none"; }
        function openProfileModal(isEditing = false, targetUserId = null, targetUserName = null) {
            const userId = isEditing ? currentUserId : targetUserId;
            const userName = isEditing ? currentUserName : targetUserName;
            profileModalTitle.textContent = isEditing ? '編輯個人資料' : `「${userName || '未知用戶'}」的個人資料`;
            profileNameInput.value = userName || '未知用戶';
            profileIntroInput.value = '讀取中...';
            profileBookInput.value = '讀取中...';
            profileIntroInput.readOnly = true;
            profileBookInput.readOnly = true;
            saveProfileBtn.style.display = 'none';
            const profileRef = database.ref(`chatrooms/${currentRoomId}/profiles/${userId}`);
            profileRef.once('value').then(snapshot => {
                const profileData = snapshot.val() || { intro: '', book: '' };
                if (isEditing) {
                    profileIntroInput.value = profileData.intro;
                    profileBookInput.value = profileData.book;
                    profileIntroInput.readOnly = false;
                    profileBookInput.readOnly = false;
                    profileForm.classList.remove('profile-viewer');
                    saveProfileBtn.style.display = 'block';
                } else {
                    profileIntroInput.value = profileData.intro || '此用戶尚未設定自我介紹。';
                    profileBookInput.value = profileData.book || '此用戶尚未設定正在閱讀的書籍。';
                    profileIntroInput.readOnly = true;
                    profileBookInput.readOnly = true;
                    profileForm.classList.add('profile-viewer');
                }
            }).catch(error => {
                console.error("讀取個人資料時發生錯誤:", error);
                profileIntroInput.value = '讀取資料失敗。';
                profileBookInput.value = '讀取資料失敗。';
            });
            profileModal.style.display = "block";
        }
        function closeProfileModal() { profileModal.style.display = "none"; }
        function saveProfile() {
            const intro = profileIntroInput.value.trim();
            const book = profileBookInput.value.trim();
            if (!currentRoomId || !currentUserId) {
                alert('錯誤：無法儲存資料，請重新登入。');
                return;
            }
            const profileRef = database.ref(`chatrooms/${currentRoomId}/profiles/${currentUserId}`);
            profileRef.set({ intro: intro, book: book })
                .then(() => { closeProfileModal(); })
                .catch(error => {
                    console.error("儲存個人資料時發生錯誤:", error);
                    alert('儲存失敗，請檢查網絡連線或權限設定。');
                });
        }
        function viewOtherUserProfile(userId, userName) {
            if (userId === currentUserId) return;
            openProfileModal(false, userId, userName);
        }
        function requestNotificationPermission() {}
        function showChatNotification({ name, text, userId }) {}
        function showGlobalNotification(message, room) {}
        function detachSingleGlobalListener(roomId) {
             if (globalListeners[roomId]) {
                const { ref, listener } = globalListeners[roomId];
                ref.off('value', listener);
                delete globalListeners[roomId];
            }
        }
        function detachSingleMemberListener(roomId) {
             if (memberListeners[roomId]) {
                const ref = database.ref('chatrooms/' + roomId + '/members');
                ref.off('value', memberListeners[roomId]);
                delete memberListeners[roomId];
            }
        }
        function detachAllGlobalListeners() { Object.keys(globalListeners).forEach(detachSingleGlobalListener); }
        function detachAllMemberListeners() { Object.keys(memberListeners).forEach(detachSingleMemberListener); }
        function listenToSingleRoom(room) {
            detachSingleGlobalListener(room.id); 
            // [修改] 監聽房間名稱的變化
            const roomNameRef = database.ref(`chatrooms/${room.id}/name`);
            const nameListener = roomNameRef.on('value', snapshot => {
                const newName = snapshot.val();
                if (newName) {
                    const roomToUpdate = savedRooms.find(r => r.id === room.id);
                    if (roomToUpdate && roomToUpdate.name !== newName) {
                        roomToUpdate.name = newName;
                        saveRoomsToStorage();
                        renderRoomList();
                        if (currentRoomId === room.id) {
                            chatHeaderName.textContent = newName;
                        }
                    }
                }
            });

            const lastMessageQuery = database.ref('chatrooms/' + room.id).orderByChild('timestamp').limitToLast(1);
            const messageListener = lastMessageQuery.on('value', (snapshot) => {
                let message = null;
                if (snapshot.exists()) {
                    const snapshotVal = snapshot.val();
                    const messageId = Object.keys(snapshotVal)[0];
                    message = snapshotVal[messageId];
                }
                const roomToUpdate = savedRooms.find(r => r.id === room.id);
                if (roomToUpdate) {
                    if (message) {
                        if (roomToUpdate.lastMessageText !== message.text || roomToUpdate.lastMessageSender !== message.name) {
                            roomToUpdate.lastMessageText = message.text;
                            roomToUpdate.lastMessageSender = message.name;
                            renderRoomList();
                        }
                    } else {
                        if (roomToUpdate.lastMessageText !== null) {
                            roomToUpdate.lastMessageText = null;
                            roomToUpdate.lastMessageSender = null;
                            renderRoomList();
                        }
                    }
                }
            }, (error) => { console.error(`Listener error for room ${room.id}:`, error); });
            globalListeners[room.id] = { ref: lastMessageQuery, listener: messageListener };
        }
        function listenToAllSavedRoomsForNotifications() {
            detachAllGlobalListeners();
            savedRooms.forEach(listenToSingleRoom);
        }
        function joinChat(userName, password) {
            enterChatButton.disabled = true;
            enterChatButton.textContent = '驗證中...';
            errorMessage.textContent = '';
            
            // 使用匿名登入來獲取一個穩定的 UID
            auth.signInAnonymously().then(userCredential => {
                currentUserId = userCredential.user.uid;
                // 將 UID 和用戶名關聯起來
                database.ref(`users/${currentUserId}`).set({ name: userName });

                const userNameRef = database.ref('usernames/' + userName);
                userNameRef.transaction(currentData => {
                    if (currentData === null || currentData === currentUserId) return currentUserId;
                    return;
                }, (error, committed, snapshot) => {
                    enterChatButton.disabled = false;
                    enterChatButton.textContent = '進入';
                    if (error) {
                        errorMessage.textContent = '發生錯誤，請重試。';
                    } else if (!committed) {
                        errorMessage.textContent = '此稱呼已被他人使用，請更換。';
                        userNameInput.focus();
                    } else {
                        currentUserName = userName;
                        currentRoomId = password;
                        messagesRef = database.ref('chatrooms/' + currentRoomId + '/messages');
                        membersRef = database.ref('chatrooms/' + currentRoomId + '/members');
                        localStorage.setItem('penpal-userName', userName);
                        
                        database.ref(`chatrooms/${currentRoomId}/name`).once('value', nameSnapshot => {
                             const roomName = nameSnapshot.val() || currentRoomId;
                             addOrUpdateRoom(currentRoomId, roomName, currentUserName);
                             chatHeaderName.textContent = roomName;
                        });

                        loginScreen.style.display = 'none';
                        chatScreen.style.display = 'flex';
                        hasCheckedProfile = false; // [新增] 每次進入房間都重置檢查狀態
                        detachSingleGlobalListener(currentRoomId);
                        addMemberToRoom(currentRoomId, currentUserName, currentUserId);
                        listenForMessages();
                        listenForMemberList();
                    }
                });
            }).catch(error => {
                enterChatButton.disabled = false;
                enterChatButton.textContent = '進入';
                errorMessage.textContent = `認證失敗: ${error.message}`;
            });
        }
        function handleLoginAttempt() {
            const userName = userNameInput.value.trim();
            const password = roomPasswordInput.value.trim();
            if (!userName) {
                errorMessage.textContent = '您的稱呼不能為空。';
                userNameInput.focus(); return;
            }
            if (!password) {
                errorMessage.textContent = '密碼不能為空。';
                roomPasswordInput.focus(); return;
            }
            joinChat(userName, password);
        }
        function logout() {
            if (currentRoomId && chatMessages.lastElementChild) {
                const lastMessageElementId = chatMessages.lastElementChild.id;
                if (lastMessageElementId && lastMessageElementId.startsWith('msg-')) {
                    const lastMessageId = lastMessageElementId.substring(4);
                    localStorage.setItem(`lastReadMsg_${currentRoomId}`, lastMessageId);
                }
            }
            stopListeningForMessages();
            stopListeningForMemberList();
            if (currentRoomId && currentUserName) { removeMemberFromRoom(currentRoomId, currentUserName); }
            currentRoomId = null;
            messagesRef = null;
            membersRef = null;
            chatScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            roomPasswordInput.value = '';
            errorMessage.textContent = '';
            listenToAllSavedRoomsForNotifications();
            userNameInput.blur();
            roomPasswordInput.blur();
            if (document.activeElement) { document.activeElement.blur(); }
        }

        // --- [新增] 配對功能邏輯 ---
        function initPairingFeature() {
            pairingToggleButton.addEventListener('click', () => {
                const isVisible = pairingPanel.style.display === 'flex';
                pairingPanel.style.display = isVisible ? 'none' : 'flex';
                pairingToggleButton.classList.toggle('active', !isVisible);
            });

            pairTwoButton.addEventListener('click', () => togglePairing(2));
            pairThreeButton.addEventListener('click', () => togglePairing(3));

            // 檢查本地存儲中是否有配對狀態
            const activePairing = localStorage.getItem('penpal-pairing');
            if (activePairing) {
                const groupSize = parseInt(activePairing, 10);
                togglePairing(groupSize, true); // 重新啟動配對
            }
        }

        async function togglePairing(groupSize, isReactivating = false) {
            if (!currentUserId || !currentUserName) {
                alert("請先設定您的稱呼並進入一次群組以完成初始化。");
                return;
            }

            const button = groupSize === 2 ? pairTwoButton : pairThreeButton;
            const otherButton = groupSize === 2 ? pairThreeButton : pairTwoButton;
            const queuePath = groupSize === 2 ? 'pairingQueue/twoPerson' : 'pairingQueue/threePerson';
            const userQueueRef = database.ref(`${queuePath}/${currentUserId}`);

            const isLit = button.classList.contains('lit');

            // 如果不是重新啟動，並且按鈕已經點亮，則取消
            if (!isReactivating && isLit) {
                await userQueueRef.remove();
                stopListeningForMatch();
                localStorage.removeItem('penpal-pairing');
                button.classList.remove('lit');
                pairingStatus.textContent = '';
                return;
            }

            // 點亮按鈕，開始配對
            otherButton.classList.remove('lit'); // 確保另一個按鈕是熄滅的
            button.classList.add('lit');
            localStorage.setItem('penpal-pairing', groupSize.toString());
            pairingStatus.textContent = `正在尋找 ${groupSize} 人群組...`;
            
            await userQueueRef.set({
                userName: currentUserName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            listenForMatch(groupSize);
        }

        function stopListeningForMatch() {
            if (pairingListener) {
                pairingListener.ref.off('value', pairingListener.callback);
                pairingListener = null;
            }
        }

        function listenForMatch(groupSize) {
            stopListeningForMatch(); // 確保只有一个監聽器
            
            const queuePath = groupSize === 2 ? 'pairingQueue/twoPerson' : 'pairingQueue/threePerson';
            const queueRef = database.ref(queuePath);

            const callback = snapshot => {
                const queue = snapshot.val();
                if (!queue) return;

                const users = Object.entries(queue).map(([id, data]) => ({ id, ...data }));
                if (users.length >= groupSize) {
                    // 按時間戳排序，最早的在前面
                    users.sort((a, b) => a.timestamp - b.timestamp);
                    const matchedUsers = users.slice(0, groupSize);
                    const matchedIds = matchedUsers.map(u => u.id);

                    // 檢查自己是否在配對成功的群組中
                    if (matchedIds.includes(currentUserId)) {
                        stopListeningForMatch(); // 成功配對，停止監聽
                        
                        // 清理本地狀態
                        localStorage.removeItem('penpal-pairing');
                        pairTwoButton.classList.remove('lit');
                        pairThreeButton.classList.remove('lit');
                        pairingStatus.textContent = "配對成功！";
                        
                        // 只有 leader (時間戳最早的) 負責創建群組
                        if (matchedUsers[0].id === currentUserId) {
                            createPairedGroup(matchedUsers);
                        }
                    }
                }
            };
            
            queueRef.on('value', callback);
            pairingListener = { ref: queueRef, callback: callback };
        }

        async function createPairedGroup(users) {
            const newRoomRef = database.ref('chatrooms').push();
            const newRoomId = newRoomRef.key;
            
            const members = {};
            users.forEach(user => {
                members[user.userName] = user.id;
            });
            
            const roomName = users.map(u => u.userName.substring(0, 4)).join('、') + '的邂逅';

            const updates = {};
            // 1. 創建聊天室基本資料
            updates[`chatrooms/${newRoomId}/name`] = roomName;
            updates[`chatrooms/${newRoomId}/members`] = members;
            
            // 2. 為每個成員更新他們的房間列表
            users.forEach(user => {
                updates[`userRooms/${user.id}/${newRoomId}`] = { name: roomName, timestamp: firebase.database.ServerValue.TIMESTAMP };
            });

            // 3. 從配對隊列中移除已配對的用戶
            const queuePath = users.length === 2 ? 'pairingQueue/twoPerson' : 'pairingQueue/threePerson';
            users.forEach(user => {
                updates[`${queuePath}/${user.id}`] = null;
            });

            try {
                await database.ref().update(updates);
                console.log(`群組 ${newRoomId} 創建成功`);
            } catch (error) {
                console.error("創建配對群組失敗:", error);
            }
        }

        // [新增] 監聽用戶自己的房間列表
        function listenUserRooms() {
            if (!currentUserId) return;
            const userRoomsRef = database.ref(`userRooms/${currentUserId}`);
            userRoomsRef.on('child_added', snapshot => {
                const roomId = snapshot.key;
                const roomData = snapshot.val();
                const isNew = !savedRooms.some(r => r.id === roomId);
                addOrUpdateRoom(roomId, roomData.name, currentUserName, isNew);
            });
             userRoomsRef.on('child_removed', snapshot => {
                const roomId = snapshot.key;
                savedRooms = savedRooms.filter(r => r.id !== roomId);
                saveRoomsToStorage();
                renderRoomList();
            });
        }
        
        async function startChatApp() {
            passwordOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
            
            const storedUserName = localStorage.getItem('penpal-userName');
            if (storedUserName) {
                userNameInput.value = storedUserName;
            }

            // 使用匿名登入，確保有 UID
            auth.signInAnonymously().catch(error => console.error("匿名登入失敗: ", error));

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUserId = user.uid;
                    currentUserName = localStorage.getItem('penpal-userName');
                    
                    // 從 localStorage 和 Firebase 載入房間列表
                    loadRoomsFromStorage();
                    renderRoomList();
                    listenToAllSavedRoomsForNotifications();
                    listenUserRooms(); // 開始監聽 Firebase 上的房間列表
                    initPairingFeature(); // 初始化配對功能
                }
            });
        }
        function verifyPassword() {
            const enteredPassword = sitePasswordInput.value.trim();
            if (!enteredPassword) {
                passwordErrorMessage.textContent = '密碼不能為空。';
                return;
            }
            sitePasswordSubmit.disabled = true;
            sitePasswordSubmit.textContent = '驗證中...';
            passwordErrorMessage.textContent = '';
            const passwordRef = database.ref('sitePassword');
            passwordRef.once('value').then(snapshot => {
                const correctPassword = snapshot.val();
                if (enteredPassword === correctPassword) {
                    localStorage.setItem('sitePasswordVerified', 'true');
                    startChatApp();
                } else {
                    passwordErrorMessage.textContent = '密碼錯誤，請重試。';
                    sitePasswordInput.value = '';
                    sitePasswordInput.focus();
                    sitePasswordSubmit.disabled = false;
                    sitePasswordSubmit.textContent = '進入';
                }
            }).catch(error => {
                console.error("讀取密碼時發生錯誤:", error);
                passwordErrorMessage.textContent = '無法驗證密碼，請檢查網絡連線。';
                sitePasswordSubmit.disabled = false;
                sitePasswordSubmit.textContent = '進入';
            });
        }
        function initializeApp() {
            if (localStorage.getItem('sitePasswordVerified') === 'true') {
                startChatApp();
            } else {
                passwordOverlay.style.display = 'flex';
                mainContainer.style.display = 'none';
            }
        }

        // --- NEW: 主執行函數 ---
        async function main() {
            try {
                // 步驟 1: 從後端 API 獲取 Firebase 設定
                // 由於沒有後端，直接在這裡填入配置
                const firebaseConfig = {
                    // 請填入您的 Firebase 配置
                    apiKey: "YOUR_API_KEY",
                    authDomain: "YOUR_AUTH_DOMAIN",
                    databaseURL: "YOUR_DATABASE_URL",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_STORAGE_BUCKET",
                    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                    appId: "YOUR_APP_ID"
                };
                 // 檢查配置是否為佔位符
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    document.body.innerHTML = `<div style="text-align: center; padding: 40px; font-family: sans-serif;">
                        <h1>應用程式設定錯誤</h1>
                        <p>Firebase 設定尚未配置。請在 main() 函數中填入您的 Firebase 專案憑證。</p>
                    </div>`;
                    return;
                }

                // 步驟 2: 使用獲取到的設定初始化 Firebase
                firebase.initializeApp(firebaseConfig);
                database = firebase.database(); // 初始化全域的 database 變數
                auth = firebase.auth(); // 初始化全域的 auth 變數

                // 步驟 3: 執行原有的應用程式啟動邏輯
                initializeApp();

            } catch (error) {
                console.error("應用程式初始化失敗:", error);
                document.body.innerHTML = `<div style="text-align: center; padding: 40px; font-family: sans-serif;">
                    <h1>應用程式載入失敗</h1>
                    <p>無法連接到伺服器以獲取必要的設定資訊，請稍後再試。</p>
                </div>`;
            }
        }

        // --- 事件監聽 ---
        enterChatButton.addEventListener('click', handleLoginAttempt);
        roomPasswordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLoginAttempt(); });
        userNameInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLoginAttempt(); });
        messageForm.addEventListener('submit', sendMessage);
        logoutButton.addEventListener('click', logout);
        editRoomNameButton.addEventListener('click', toggleRoomNameEdit);
        memberInfoButton.addEventListener('click', openMemberModal);
        closeModalBtn.addEventListener('click', closeMemberModal);
        window.addEventListener('click', (event) => {
            if (event.target === memberModal) closeMemberModal();
            if (event.target === profileModal) closeProfileModal();
            // [新增] 點擊面板外部時關閉面板
            if (!pairingPanel.contains(event.target) && !pairingToggleButton.contains(event.target)) {
                pairingPanel.style.display = 'none';
                pairingToggleButton.classList.remove('active');
            }
        });
        userProfileButton.addEventListener('click', () => { openProfileModal(true); });
        saveProfileBtn.addEventListener('click', saveProfile);
        closeProfileBtns.forEach(btn => btn.addEventListener('click', closeProfileModal));
        sitePasswordSubmit.addEventListener('click', verifyPassword);
        sitePasswordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') verifyPassword(); });
        window.addEventListener('beforeunload', () => {
            if (currentRoomId && chatMessages.lastElementChild) {
                const lastMessageElementId = chatMessages.lastElementChild.id;
                if (lastMessageElementId && lastMessageElementId.startsWith('msg-')) {
                    const lastMessageId = lastMessageElementId.substring(4);
                    localStorage.setItem(`lastReadMsg_${currentRoomId}`, lastMessageId);
                }
            }
        });
        
        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
