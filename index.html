<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <title>創作社——以文會友</title>
    <!-- 添加到主畫面設定 -->
    <meta name="application-name" content="以文會友">
    <meta name="apple-mobile-web-app-title" content="以文會友">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.ibb.co/fYPQnzLS/image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Android 圖示 -->
    <link rel="icon" sizes="192x192" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="icon" sizes="144x144" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="icon" sizes="96x96" href="https://i.ibb.co/fYPQnzLS/image.png">
    <!-- iOS 圖示 -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/fYPQnzLS/image.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://i.ibb.co/fYPQnzLS/image.png">
    <style>
        /* --- 全局與侘寂風設計 (新色調) --- */
        :root {
            --background-color: #f4f4f5; /* 更柔和的灰白背景 */
            --text-color: #333;
            --primary-color: #607D8B; /* 低調的灰藍色 */
            --primary-color-hover: #546E7A; /* 按鈕懸停色 */
            --border-color: #e0e0e0; /* 更淺的邊框 */
            --input-bg-color: #fff;
            --message-bg-color: #eceff1; /* 訊息氣泡背景 */
            --font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            --danger-color: #c95c58;
            --danger-color-hover: #b04b47;
            --subtle-text-color: #777; /* 用於預覽文字 */
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            background-image: url('背景圖片.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        /* --- (新增) 密碼驗證畫面 --- */
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            padding: 15px;
        }
        .password-box {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        .password-box h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .password-box .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }
        #site-password-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #site-password-submit {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #site-password-submit:hover {
            background-color: var(--primary-color-hover);
        }
        #site-password-submit:disabled {
            background-color: #90a4ae;
            cursor: not-allowed;
        }
        #password-error-message {
            color: #d9534f;
            margin-top: 15px;
            height: 20px;
            font-size: 14px;
        }
        /* --- 主容器 --- */
        .container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            max-height: 900px;
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* --- 登入畫面 --- */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px 40px;
            text-align: center;
            overflow-y: auto;
        }
        #login-screen h1 {
            font-size: 28px;
            font-weight: 500;
            margin-bottom: 25px;
            color: var(--text-color);
        }
        #room-list-container {
            width: 100%;
            max-width: 380px;
            margin-bottom: 25px;
            text-align: left;
        }
        #room-list-container h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        #room-list {
            list-style-type: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #room-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        #room-list li:last-child {
            border-bottom: none;
        }
        #room-list li:hover {
            background-color: #f9f9f9;
        }
        .room-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            margin-right: 10px;
        }
        .room-name {
            font-weight: 600;
            font-size: 17px;
            color: #263238;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .last-message-preview {
            font-size: 14px;
            color: var(--subtle-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-message-sender {
            font-weight: 600;
            color: var(--primary-color);
        }
        .no-message-info {
            font-style: italic;
            font-size: 14px;
            color: #999;
        }
        .delete-room-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 15px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        #room-list li:hover .delete-room-btn {
            opacity: 0.8;
        }
        .delete-room-btn:hover {
            opacity: 1;
            background-color: var(--danger-color-hover);
        }
        #no-rooms-message {
            color: #999;
            font-size: 14px;
            padding: 20px;
            text-align: center;
            cursor: default;
        }
        #no-rooms-message:hover {
            background-color: transparent;
        }
        .login-divider {
            margin: 15px 0;
            font-size: 14px;
            color: #999;
        }
        .input-group {
            width: 100%;
            max-width: 380px;
            margin-bottom: 15px;
        }
        .input-field {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg-color);
            transition: border-color 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .btn {
            padding: 12px 20px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
            width: 100%;
            max-width: 380px;
        }
        .btn:hover {
            background-color: var(--primary-color-hover);
        }
        .btn:disabled {
            background-color: #90a4ae;
            cursor: not-allowed;
        }
        #error-message {
            color: #d9534f;
            margin-top: 15px;
            height: 20px;
            font-size: 14px;
        }
        /* --- 聊天室畫面 --- */
        #chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fcfcfc;
            flex-shrink: 0;
            position: sticky; 
            top: 0; 
            z-index: 10; 
            min-height: 60px; 
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        #chat-room-name {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #chat-room-name[contenteditable="true"] {
            outline: none;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 2px;
        }
        #edit-room-name-button,
        #member-info-button,
        #user-profile-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s; 
            color: var(--text-color); 
        }
        #edit-room-name-button:hover,
        #member-info-button:hover,
        #user-profile-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        #edit-room-name-button svg,
        #member-info-button svg,
        #user-profile-button svg {
            width: 20px;
            height: 20px;
        }
        #logout-button {
            font-size: 14px;
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }
        #logout-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: url('對話背景圖.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        .message-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sender-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            margin-left: 5px;
            cursor: pointer; 
        }
        .sender-name:hover {
            text-decoration: underline; 
        }
        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 12px;
            background-color: rgba(236, 239, 241, 0.9);
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message .timestamp {
            font-size: 11px;
            color: #999;
            display: block;
            margin-top: 5px;
            text-align: right;
            opacity: 0.7;
        }
        .message-group.own-message {
            align-items: flex-end;
        }
        .message-group.own-message .sender-name {
            display: none;
        }
        .message-group.own-message .message {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .message-group.own-message .message .timestamp {
            color: #e0e0e0;
            opacity: 0.8;
        }
        .chat-input {
            display: flex;
            align-items: center;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #fcfcfc;
            flex-shrink: 0;
        }
        .chat-input #message-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 16px;
        }
        .chat-input #message-input:focus {
             outline: none;
            border-color: var(--primary-color);
        }
        #send-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s; 
        }
        #send-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1); 
        }
        #send-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
        }

        /* --- [新增] 新留言分隔線樣式 --- */
        .new-messages-separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 5px;
            color: var(--subtle-text-color);
        }
        .new-messages-separator::before,
        .new-messages-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        .new-messages-separator span {
            padding: 0 15px;
            font-size: 13px;
            font-family: var(--font-family);
        }
        
        /* --- 成員列表彈出視窗 --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--input-bg-color);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-color);
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s; 
        }
        .close:hover,
        .close:focus {
            color: black;
            transform: scale(1.1); 
        }
        .member-list {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .member-list li {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; 
        }
        .member-list li:hover {
            background-color: #f0f0f0;
        }
        .member-list li:last-child {
            border-bottom: none;
        }
        .member-count {
            font-size: 14px;
            color: var(--subtle-text-color);
            margin-top: 10px;
            text-align: right;
        }
        /* --- 個人資料彈出視窗 (新增) --- */
        #profileModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .profile-modal-content {
            background-color: var(--input-bg-color);
            margin: 15% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .profile-modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-color);
        }
        .profile-form-group {
            margin-bottom: 15px;
        }
        .profile-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }
        .profile-input-field {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg-color);
            transition: border-color 0.3s;
        }
        .profile-input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .profile-viewer .profile-input-field {
            background-color: #f9f9f9;
            cursor: default;
        }
        .profile-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .profile-btn-submit {
            font-family: var(--font-family);
            font-size: 15px;
            padding: 10px 30px;
            border-radius: 25px;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }
        .profile-btn-submit:hover {
            background-color: var(--primary-color);
            color: #fff;
            box-shadow: 0 2px 8px rgba(96, 125, 139, 0.2);
        }

        @media (max-width: 600px) {
            html, body {
                overflow: hidden; /* 防止整個頁面滾動 */
            }
            body { padding: 0; }
            .container {
                height: 100%; /* 使用 100% 以獲得更好的兼容性 */
                max-height: 100%;
                border-radius: 0;
                border: none;
                padding-top: env(safe-area-inset-top); /* 尊重頂部安全區域（瀏海） */
            }
            #login-screen { padding: 20px; }
            .modal-content,
            .profile-modal-content {
                width: 95%;
                margin: 20% auto;
            }
            .password-box {
                padding: 25px;
            }
            .chat-header {
                padding: 15px 15px 10px 15px; /* 增加頂部內邊距 */
            }
            .header-left, .header-right {
                gap: 8px;
            }
            .chat-messages {
                padding: 10px;
            }
            .chat-input {
                 padding-bottom: env(safe-area-inset-bottom); /* 尊重底部安全區域（Home Indicator） */
            }
        }
    </style>
</head>
<body>
    <!-- 密碼驗證畫面 -->
    <div id="password-overlay">
        <div class="password-box">
            <h1>請輸入通行密碼</h1>
            <p class="subtitle">此為私人創作空間，請輸入密碼以繼續。</p>
            <input type="password" id="site-password-input" class="input-field" placeholder="通行密碼...">
            <button id="site-password-submit">進入</button>
            <p id="password-error-message"></p>
        </div>
    </div>
    <!-- 主容器 -->
    <div class="container" style="display: none;">
        <!-- 登入畫面 -->
        <div id="login-screen">
            <h1>創作社——以文會友</h1>
            <div id="room-list-container">
                <h2>我的文友群組</h2>
                <ul id="room-list">
                    <!-- Javascript 會動態填入這裡 -->
                </ul>
            </div>
            <div class="login-divider">或加入/建立新的群組</div>
            <div class="input-group">
                <input type="text" id="user-name" class="input-field" placeholder="您的稱呼..." autocomplete="off">
            </div>
            <div class="input-group">
                <input type="password" id="room-password" class="input-field" placeholder="交流密碼..." autocomplete="off">
            </div>
            <button id="enter-chat-button" class="btn">進入</button>
            <p id="error-message"></p>
        </div>
        <!-- 聊天室畫面 -->
        <div id="chat-screen">
            <header class="chat-header">
                <div class="header-left">
                    <h2 id="chat-room-name" spellcheck="false">交流空間</h2>
                    <button id="edit-room-name-button" title="修訂群組名稱">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="header-right">
                    <button id="member-info-button" title="檢視群組成員">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                        </svg>
                    </button>
                    <button id="user-profile-button" title="編輯個人資料">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <a id="logout-button" title="關閉">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </header>
            <div id="chat-messages" class="chat-messages"></div>
            <form id="message-form" class="chat-input">
                <input type="text" id="message-input" class="input-field" placeholder="分享你的閱讀心得..." autocomplete="off">
                <button type="submit" id="send-button" title="傳送">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </form>
        </div>
    </div>
    <!-- 成員列表彈出視窗 -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>群組成員</h2>
                <span class="close">&times;</span>
            </div>
            <ul id="member-list" class="member-list">
                <!-- 成員列表將動態填入 -->
            </ul>
            <div id="member-count" class="member-count">
                <!-- 人數將動態填入 -->
            </div>
        </div>
    </div>
    <!-- 個人資料彈出視窗 -->
    <div id="profileModal" class="modal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2 id="profile-modal-title">個人資料</h2>
                <span class="close close-profile">&times;</span>
            </div>
            <form id="profile-form">
                <div class="profile-form-group">
                    <label for="profile-name" class="profile-label">姓名</label>
                    <input type="text" id="profile-name" class="profile-input-field" readonly>
                </div>
                <div class="profile-form-group">
                    <label for="profile-intro" class="profile-label">自我介紹</label>
                    <textarea id="profile-intro" class="profile-input-field" rows="3"></textarea>
                </div>
                <div class="profile-form-group">
                    <label for="profile-book" class="profile-label">正在閱讀</label>
                    <input type="text" id="profile-book" class="profile-input-field">
                </div>
                <div class="profile-buttons">
                    <button type="button" class="profile-btn-submit" id="save-profile-btn">儲存設定</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script>
        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBbNddSd8xF3tQJEfj42i2sSkAVK7SfqFw",
            authDomain: "matching-72d36.firebaseapp.com",
            databaseURL: "https://matching-72d36-default-rtdb.firebaseio.com",
            projectId: "matching-72d36",
            storageBucket: "matching-72d36.firebasestorage.app",
            messagingSenderId: "66478784623",
            appId: "1:66478784623:web:9a5e3636b78e31280f0d9a"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // --- DOM 元素獲取 ---
        const passwordOverlay = document.getElementById('password-overlay');
        const sitePasswordInput = document.getElementById('site-password-input');
        const sitePasswordSubmit = document.getElementById('site-password-submit');
        const passwordErrorMessage = document.getElementById('password-error-message');
        const mainContainer = document.querySelector('.container');
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const userNameInput = document.getElementById('user-name');
        const roomPasswordInput = document.getElementById('room-password');
        const enterChatButton = document.getElementById('enter-chat-button');
        const errorMessage = document.getElementById('error-message');
        const logoutButton = document.getElementById('logout-button');
        const chatHeaderName = document.getElementById('chat-room-name');
        const editRoomNameButton = document.getElementById('edit-room-name-button');
        const memberInfoButton = document.getElementById('member-info-button');
        const userProfileButton = document.getElementById('user-profile-button');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const roomList = document.getElementById('room-list');
        const memberModal = document.getElementById('memberModal');
        const closeModalBtn = document.querySelector('.close');
        const memberListElement = document.getElementById('member-list');
        const memberCountElement = document.getElementById('member-count');

        // --- 個人資料相關 DOM 元素 ---
        const profileModal = document.getElementById('profileModal');
        const profileModalTitle = document.getElementById('profile-modal-title');
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileIntroInput = document.getElementById('profile-intro');
        const profileBookInput = document.getElementById('profile-book');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const closeProfileBtns = document.querySelectorAll('.close-profile');

        // --- 全局狀態 ---
        let currentRoomId = null;
        let currentUserName = null;
        let currentUserId = null;
        let messagesRef = null;
        let membersRef = null;
        let savedRooms = [];
        let globalListeners = {};
        let memberListeners = {};
        let isEditingRoomName = false;
        let originalRoomName = '';
        const USER_COLORS = ['#e57373', '#ba68c8', '#7986cb', '#4fc3f7', '#4db6ac', '#aed581', '#ffb74d', '#ff8a65', '#90a4ae', '#a1887f'];
        function getColorForUserId(userId) {
            let hash = 0;
            for (let i = 0; i < userId.length; i++) hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            return USER_COLORS[Math.abs(hash % USER_COLORS.length)];
        }
        
        // --- 群組清單管理 ---
        function saveRoomsToStorage() {
            const roomsToSave = savedRooms.map(({ id, name, userName }) => ({ id, name, userName }));
            localStorage.setItem('penpal-rooms', JSON.stringify(roomsToSave));
        }
        function loadRoomsFromStorage() {
            const roomsJSON = localStorage.getItem('penpal-rooms');
            savedRooms = roomsJSON ? JSON.parse(roomsJSON) : [];
        }
        function renderRoomList() {
            roomList.innerHTML = '';
            if (savedRooms.length === 0) {
                roomList.innerHTML = '<li id="no-rooms-message">尚未儲存任何群組</li>';
                return;
            }
            savedRooms.forEach(room => {
                const li = document.createElement('li');
                li.setAttribute('data-room-id', room.id);
                const roomInfoDiv = document.createElement('div');
                roomInfoDiv.className = 'room-info';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'room-name';
                nameSpan.textContent = room.name;
                roomInfoDiv.appendChild(nameSpan);
                const previewDiv = document.createElement('div');
                if (room.lastMessageText) {
                    previewDiv.className = 'last-message-preview';
                    const senderSpan = document.createElement('span');
                    senderSpan.className = 'last-message-sender';
                    senderSpan.textContent = `${room.lastMessageSender}: `;
                    const textSpan = document.createElement('span');
                    textSpan.className = 'last-message-text';
                    textSpan.textContent = room.lastMessageText;
                    previewDiv.appendChild(senderSpan);
                    previewDiv.appendChild(textSpan);
                } else {
                    previewDiv.className = 'no-message-info';
                    previewDiv.textContent = '尚無訊息';
                }
                roomInfoDiv.appendChild(previewDiv);
                li.appendChild(roomInfoDiv);
                li.addEventListener('click', () => {
                    const clickedRoom = savedRooms.find(r => r.id === room.id);
                    if (!clickedRoom) return;
                    if (clickedRoom.userName) {
                        userNameInput.value = clickedRoom.userName;
                    }
                    roomPasswordInput.value = clickedRoom.id;
                    handleLoginAttempt();
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-room-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = '從列表中移除';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`確定要從列表中移除「${room.name}」嗎？\n此操作亦會將您從該群組成員名單中移除。`)) {
                        const userNameToRemove = localStorage.getItem('penpal-userName');
                        if (userNameToRemove) {
                            removeMemberFromRoom(room.id, userNameToRemove);
                        }
                        detachSingleGlobalListener(room.id);
                        detachSingleMemberListener(room.id);
                        savedRooms = savedRooms.filter(r => r.id !== room.id);
                        saveRoomsToStorage();
                        renderRoomList();
                    }
                });
                li.appendChild(deleteBtn);
                roomList.appendChild(li);
            });
        }

        // [REMOVED] The updateAndRenderRoomList function is now removed. Its functionality is merged into the new real-time listener.

        function addOrUpdateRoom(roomId, roomName, userName) {
            let existingRoom = savedRooms.find(r => r.id === roomId);
            if (existingRoom) {
                existingRoom.name = roomName;
                existingRoom.userName = userName;
            } else {
                existingRoom = { id: roomId, name: roomName, userName: userName };
                savedRooms.push(existingRoom);
            }
            saveRoomsToStorage();
            listenToSingleRoom(existingRoom); // Attach the real-time listener for this room.
            renderRoomList(); // Re-render to immediately show the name change. The listener will fill in the message.
        }
        
        const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
        const saveIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;

        function handleRoomNameKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                chatHeaderName.blur();
            } else if (event.key === 'Escape') {
                isEditingRoomName = false;
                chatHeaderName.blur();
            }
        }

        function toggleRoomNameEdit() {
            if (isEditingRoomName) {
                const newName = chatHeaderName.textContent.trim();
                chatHeaderName.removeEventListener('keydown', handleRoomNameKeydown);
                chatHeaderName.contentEditable = false;
                editRoomNameButton.innerHTML = editIconSVG;
                editRoomNameButton.title = '修訂群組名稱';
                
                if (newName && newName !== originalRoomName) {
                    addOrUpdateRoom(currentRoomId, newName, currentUserName);
                    chatHeaderName.textContent = newName;
                } else {
                    chatHeaderName.textContent = originalRoomName;
                }
                isEditingRoomName = false;

            } else {
                isEditingRoomName = true;
                originalRoomName = chatHeaderName.textContent;
                chatHeaderName.contentEditable = true;
                chatHeaderName.focus();
                document.execCommand('selectAll', false, null);
                editRoomNameButton.innerHTML = saveIconSVG;
                editRoomNameButton.title = '儲存名稱';
                
                chatHeaderName.addEventListener('keydown', handleRoomNameKeydown);
                chatHeaderName.addEventListener('blur', () => {
                    if (!isEditingRoomName) {
                        chatHeaderName.textContent = originalRoomName;
                    }
                    toggleRoomNameEdit();
                }, { once: true });
            }
        }

        function getUserId() {
            let userId = localStorage.getItem('penpal-userId');
            if (!userId) {
                userId = Date.now().toString(36) + Math.random().toString(36).substr(2);
                localStorage.setItem('penpal-userId', userId);
            }
            return userId;
        }
        function displayMessage({ name, text, timestamp, userId }, messageId) {
            const messageGroup = document.createElement('div');
            messageGroup.id = `msg-${messageId}`;
            messageGroup.classList.add('message-group');
            if (userId === currentUserId) messageGroup.classList.add('own-message');
            const senderName = document.createElement('div');
            senderName.classList.add('sender-name');
            senderName.textContent = name || '匿名';
            senderName.style.color = getColorForUserId(userId);
            senderName.setAttribute('data-user-id', userId); 
            senderName.addEventListener('click', (e) => {
                e.stopPropagation();
                if (userId !== currentUserId) {
                    viewOtherUserProfile(userId, name);
                }
            });

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            const textNode = document.createElement('span');
            textNode.textContent = text;
            const timeNode = document.createElement('span');
            timeNode.classList.add('timestamp');
            timeNode.textContent = new Date(timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            messageElement.appendChild(textNode);
            messageElement.appendChild(timeNode);
            messageGroup.appendChild(senderName);
            messageGroup.appendChild(messageElement);
            chatMessages.appendChild(messageGroup);
            return messageGroup;
        }
        
        function listenForMessages() {
            if (messagesRef) {
                chatMessages.innerHTML = '';
                const lastReadMessageId = localStorage.getItem(`lastReadMsg_${currentRoomId}`);
                let firstUnreadElement = null;
                let lastReadMessageFound = !lastReadMessageId; 

                const scrollToBottom = () => {
                    setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 0);
                };

                const scrollToFirstUnread = () => {
                    if (firstUnreadElement) {
                        const separator = document.createElement('div');
                        separator.className = 'new-messages-separator';
                        separator.innerHTML = '<span>新留言</span>';
                        chatMessages.insertBefore(separator, firstUnreadElement);

                        separator.scrollIntoView({ behavior: 'auto', block: 'center' });

                        firstUnreadElement.style.transition = 'background-color 0.5s';
                        firstUnreadElement.style.backgroundColor = 'rgba(96, 125, 139, 0.1)';
                        setTimeout(() => {
                            firstUnreadElement.style.backgroundColor = '';
                        }, 2000);
                    } else {
                        scrollToBottom();
                    }
                };
                
                messagesRef.on('child_added', snapshot => {
                    const message = snapshot.val();
                    const messageId = snapshot.key;
                    if(message) {
                        const messageElement = displayMessage(message, messageId);

                        if (!lastReadMessageFound) {
                            if (messageId === lastReadMessageId) {
                                lastReadMessageFound = true; 
                            }
                        } else if (!firstUnreadElement) {
                            firstUnreadElement = messageElement;
                        }

                        const isNearBottom = chatMessages.scrollHeight - chatMessages.clientHeight - chatMessages.scrollTop < 100;
                        if (isNearBottom) {
                            scrollToBottom();
                        }
                        
                        if (message.userId !== currentUserId) {
                             showChatNotification(message);
                        }
                    }
                });

                messagesRef.once('value', () => {
                    setTimeout(scrollToFirstUnread, 100);
                });
            }
        }

        function stopListeningForMessages() {
            if (messagesRef) messagesRef.off();
        }
        function sendMessage(event) {
            event.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText && messagesRef && currentUserName && currentUserId) {
                const messageData = {
                    name: currentUserName,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userId: currentUserId
                };
                messagesRef.push(messageData).catch(error => {
                     console.error("訊息發送失敗:", error);
                     alert("無法發送訊息，可能是權限問題或網絡連線中斷。");
                });
                messageInput.value = '';
            }
        }
        function listenForMemberList() {
            if (membersRef) {
                 memberListElement.innerHTML = '';
                 if (memberListeners[currentRoomId]) {
                     membersRef.off('value', memberListeners[currentRoomId]);
                 }
                 memberListeners[currentRoomId] = function(snapshot) {
                     const members = snapshot.val();
                     memberListElement.innerHTML = '';
                     if (members) {
                         const memberNames = Object.keys(members);
                         memberNames.forEach(name => {
                             const li = document.createElement('li');
                             li.textContent = name;
                             li.addEventListener('click', (e) => {
                                 e.stopPropagation();
                                 const userId = members[name];
                                 if (userId !== currentUserId) {
                                     viewOtherUserProfile(userId, name);
                                 }
                             });
                             memberListElement.appendChild(li);
                         });
                         memberCountElement.textContent = `總人數: ${memberNames.length}`;
                     } else {
                         memberCountElement.textContent = `總人數: 0`;
                     }
                 };
                 membersRef.on('value', memberListeners[currentRoomId]);
            }
        }
        function stopListeningForMemberList() {
            if (membersRef && memberListeners[currentRoomId]) {
                membersRef.off('value', memberListeners[currentRoomId]);
                delete memberListeners[currentRoomId];
            }
        }
        function addMemberToRoom(roomId, userName, userId) {
            const memberRef = database.ref('chatrooms/' + roomId + '/members/' + userName);
            memberRef.set(userId).catch(error => {
                console.error("加入成員列表失敗:", error);
            });
        }
        function removeMemberFromRoom(roomId, userName) {
            const memberRef = database.ref('chatrooms/' + roomId + '/members/' + userName);
            memberRef.remove().catch(error => {
                console.error("移除成員失敗:", error);
            });
        }
        function openMemberModal() {
            memberModal.style.display = "block";
        }
        function closeMemberModal() {
            memberModal.style.display = "none";
        }

        function openProfileModal(isEditing = false, targetUserId = null, targetUserName = null) {
            const userId = isEditing ? currentUserId : targetUserId;
            const userName = isEditing ? currentUserName : targetUserName;

            profileModalTitle.textContent = isEditing ? '編輯個人資料' : `「${userName || '未知用戶'}」的個人資料`;
            profileNameInput.value = userName || '未知用戶';

            profileIntroInput.value = '讀取中...';
            profileBookInput.value = '讀取中...';
            profileIntroInput.readOnly = true;
            profileBookInput.readOnly = true;
            saveProfileBtn.style.display = 'none';

            const profileRef = database.ref(`chatrooms/${currentRoomId}/profiles/${userId}`);
            profileRef.once('value').then(snapshot => {
                const profileData = snapshot.val() || { intro: '', book: '' };

                if (isEditing) {
                    profileIntroInput.value = profileData.intro;
                    profileBookInput.value = profileData.book;
                    profileIntroInput.readOnly = false;
                    profileBookInput.readOnly = false;
                    profileForm.classList.remove('profile-viewer');
                    saveProfileBtn.style.display = 'block';
                } else {
                    profileIntroInput.value = profileData.intro || '此用戶尚未設定自我介紹。';
                    profileBookInput.value = profileData.book || '此用戶尚未設定正在閱讀的書籍。';
                    profileIntroInput.readOnly = true;
                    profileBookInput.readOnly = true;
                    profileForm.classList.add('profile-viewer');
                }
            }).catch(error => {
                console.error("讀取個人資料時發生錯誤:", error);
                profileIntroInput.value = '讀取資料失敗。';
                profileBookInput.value = '讀取資料失敗。';
            });

            profileModal.style.display = "block";
        }

        function closeProfileModal() {
            profileModal.style.display = "none";
        }

        function saveProfile() {
            const intro = profileIntroInput.value.trim();
            const book = profileBookInput.value.trim();

            if (!currentRoomId || !currentUserId) {
                alert('錯誤：無法儲存資料，請重新登入。');
                return;
            }

            const profileRef = database.ref(`chatrooms/${currentRoomId}/profiles/${currentUserId}`);
            profileRef.set({
                intro: intro,
                book: book
            }).then(() => {
                closeProfileModal();
            }).catch(error => {
                console.error("儲存個人資料時發生錯誤:", error);
                alert('儲存失敗，請檢查網絡連線或權限設定。');
            });
        }

        function viewOtherUserProfile(userId, userName) {
            if (userId === currentUserId) return;
            openProfileModal(false, userId, userName);
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') console.log('桌面通知權限已成功獲取！');
                });
            }
        }
        function showChatNotification({ name, text, userId }) {
            if (Notification.permission === 'granted' && userId !== currentUserId && document.hidden) {
                const notification = new Notification(`來自 ${name} 的新訊息`, {
                    body: text,
                    icon: 'https://i.ibb.co/fYPQnzLS/image.png'
                });
                notification.onclick = () => window.focus();
            }
        }
        function showGlobalNotification(message, room) {
             if (Notification.permission === 'granted' && message && message.userId !== currentUserId) {
                const notification = new Notification(`交流群組「${room.name}」有新訊息`, {
                    body: `${message.name}: ${message.text}`,
                    icon: 'https://i.ibb.co/fYPQnzLS/image.png',
                    tag: room.id
                });
                notification.onclick = () => {
                    roomPasswordInput.value = room.id;
                    window.focus();
                };
            }
        }
        
        // [MODIFIED] The listener detachment function is updated for the new listener type.
        function detachSingleGlobalListener(roomId) {
             if (globalListeners[roomId]) {
                const { ref, listener } = globalListeners[roomId];
                ref.off('value', listener); // Use 'value' as the event type
                delete globalListeners[roomId];
            }
        }

        function detachSingleMemberListener(roomId) {
             if (memberListeners[roomId]) {
                const ref = database.ref('chatrooms/' + roomId + '/members');
                ref.off('value', memberListeners[roomId]);
                delete memberListeners[roomId];
            }
        }
        function detachAllGlobalListeners() {
            Object.keys(globalListeners).forEach(detachSingleGlobalListener);
        }
        function detachAllMemberListeners() {
            Object.keys(memberListeners).forEach(detachSingleMemberListener);
        }

        // [MODIFIED] This function is now the single source of truth for fetching and listening to last message updates.
        function listenToSingleRoom(room) {
            detachSingleGlobalListener(room.id); 

            const lastMessageQuery = database.ref('chatrooms/' + room.id).orderByChild('timestamp').limitToLast(1);
            
            const listener = lastMessageQuery.on('value', (snapshot) => {
                let message = null;
                if (snapshot.exists()) {
                    const snapshotVal = snapshot.val();
                    const messageId = Object.keys(snapshotVal)[0];
                    message = snapshotVal[messageId];
                }

                const roomToUpdate = savedRooms.find(r => r.id === room.id);
                if (roomToUpdate) {
                    if (message) {
                        if (roomToUpdate.lastMessageText !== message.text || roomToUpdate.lastMessageSender !== message.name) {
                            roomToUpdate.lastMessageText = message.text;
                            roomToUpdate.lastMessageSender = message.name;
                            renderRoomList();
                        }
                    } else {
                        if (roomToUpdate.lastMessageText !== null) {
                            roomToUpdate.lastMessageText = null;
                            roomToUpdate.lastMessageSender = null;
                            renderRoomList();
                        }
                    }
                }
                
                if (message && message.timestamp > (Date.now() - 5000) && room.id !== currentRoomId) {
                     showGlobalNotification(message, room);
                }
            }, (error) => {
                console.error(`Listener error for room ${room.id}:`, error);
            });

            globalListeners[room.id] = { ref: lastMessageQuery, listener: listener };
        }

        function listenToAllSavedRoomsForNotifications() {
            detachAllGlobalListeners();
            savedRooms.forEach(listenToSingleRoom);
        }
        function joinChat(userName, password) {
            const userId = getUserId();
            const userNameRef = database.ref('usernames/' + userName);
            enterChatButton.disabled = true;
            enterChatButton.textContent = '驗證中...';
            errorMessage.textContent = '';
            userNameRef.transaction(currentData => {
                if (currentData === null || currentData === userId) return userId;
                return;
            }, (error, committed, snapshot) => {
                enterChatButton.disabled = false;
                enterChatButton.textContent = '進入';
                if (error) {
                    errorMessage.textContent = '發生錯誤，請重試。';
                } else if (!committed) {
                    errorMessage.textContent = '此稱呼已被他人使用，請更換。';
                    userNameInput.focus();
                } else {
                    currentUserName = userName;
                    currentUserId = userId;
                    currentRoomId = password;
                    messagesRef = database.ref('chatrooms/' + currentRoomId);
                    membersRef = database.ref('chatrooms/' + currentRoomId + '/members');
                    localStorage.setItem('penpal-userName', userName);
                    const roomInfo = savedRooms.find(r => r.id === currentRoomId);
                    const roomName = roomInfo ? roomInfo.name : currentRoomId;
                    
                    addOrUpdateRoom(currentRoomId, roomName, currentUserName);
                    
                    chatHeaderName.textContent = roomName;
                    loginScreen.style.display = 'none';
                    chatScreen.style.display = 'flex';
                    detachSingleGlobalListener(currentRoomId);
                    addMemberToRoom(currentRoomId, currentUserName, currentUserId);
                    listenForMessages();
                    listenForMemberList();
                    // messageInput.focus(); // 將此行註解或刪除
                }
            });
        }
        function handleLoginAttempt() {
            const userName = userNameInput.value.trim();
            const password = roomPasswordInput.value.trim();
            if (!userName) {
                errorMessage.textContent = '您的稱呼不能為空。';
                userNameInput.focus(); return;
            }
            if (!password) {
                errorMessage.textContent = '密碼不能為空。';
                roomPasswordInput.focus(); return;
            }
            joinChat(userName, password);
        }
        function logout() {
            if (currentRoomId && chatMessages.lastElementChild) {
                const lastMessageElementId = chatMessages.lastElementChild.id;
                if (lastMessageElementId && lastMessageElementId.startsWith('msg-')) {
                    const lastMessageId = lastMessageElementId.substring(4);
                    localStorage.setItem(`lastReadMsg_${currentRoomId}`, lastMessageId);
                }
            }
            
            stopListeningForMessages();
            stopListeningForMemberList();
            if (currentRoomId && currentUserName) {
                removeMemberFromRoom(currentRoomId, currentUserName);
            }
            currentRoomId = null;
            messagesRef = null;
            membersRef = null;
            chatScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            roomPasswordInput.value = '';
            errorMessage.textContent = '';
  
            listenToAllSavedRoomsForNotifications();
         
            // --- 新增這兩行 ---
            userNameInput.blur();
            roomPasswordInput.blur();
   
            if (document.activeElement) {
                document.activeElement.blur();
            }
        }
        
        // [MODIFIED] Startup logic is simplified.
       // --- 應用程式啟動邏輯 ---
        async function startChatApp() {
            passwordOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
            currentUserId = getUserId();
            const storedUserName = localStorage.getItem('penpal-userName');
            if (storedUserName) {
                userNameInput.value = storedUserName;
            }
            loadRoomsFromStorage();
            renderRoomList();
            requestNotificationPermission();
            listenToAllSavedRoomsForNotifications();
            // userNameInput.focus(); // 將此行註解或刪除
        }

        function verifyPassword() {
            const enteredPassword = sitePasswordInput.value.trim();
            if (!enteredPassword) {
                passwordErrorMessage.textContent = '密碼不能為空。';
                return;
            }
            sitePasswordSubmit.disabled = true;
            sitePasswordSubmit.textContent = '驗證中...';
            passwordErrorMessage.textContent = '';
            const passwordRef = database.ref('sitePassword');
            passwordRef.once('value').then(snapshot => {
                const correctPassword = snapshot.val();
                if (enteredPassword === correctPassword) {
                    localStorage.setItem('sitePasswordVerified', 'true');
                    startChatApp();
                } else {
                    passwordErrorMessage.textContent = '密碼錯誤，請重試。';
                    sitePasswordInput.value = '';
                    sitePasswordInput.focus();
                    sitePasswordSubmit.disabled = false;
                    sitePasswordSubmit.textContent = '進入';
                }
            }).catch(error => {
                console.error("讀取密碼時發生錯誤:", error);
                passwordErrorMessage.textContent = '無法驗證密碼，請檢查網絡連線。';
                sitePasswordSubmit.disabled = false;
                sitePasswordSubmit.textContent = '進入';
            });
        }
        function initializeApp() {
            if (localStorage.getItem('sitePasswordVerified') === 'true') {
                startChatApp();
            } else {
                passwordOverlay.style.display = 'flex';
                mainContainer.style.display = 'none';
              // sitePasswordInput.focus(); // 將此行註解或刪除
            }
        }
        // --- 事件監聽 ---
        enterChatButton.addEventListener('click', handleLoginAttempt);
        roomPasswordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLoginAttempt(); });
        userNameInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLoginAttempt(); });
        messageForm.addEventListener('submit', sendMessage);
        logoutButton.addEventListener('click', logout);
        editRoomNameButton.addEventListener('click', toggleRoomNameEdit);
        memberInfoButton.addEventListener('click', openMemberModal);
        closeModalBtn.addEventListener('click', closeMemberModal);
        window.addEventListener('click', (event) => {
            if (event.target === memberModal) {
                closeMemberModal();
            }
            if (event.target === profileModal) {
                closeProfileModal();
            }
        });

        userProfileButton.addEventListener('click', () => {
            openProfileModal(true);
        });
        saveProfileBtn.addEventListener('click', saveProfile);
        closeProfileBtns.forEach(btn => btn.addEventListener('click', closeProfileModal));

        sitePasswordSubmit.addEventListener('click', verifyPassword);
        sitePasswordInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                verifyPassword();
            }
        });

        window.addEventListener('beforeunload', () => {
            if (currentRoomId && chatMessages.lastElementChild) {
                const lastMessageElementId = chatMessages.lastElementChild.id;
                if (lastMessageElementId && lastMessageElementId.startsWith('msg-')) {
                    const lastMessageId = lastMessageElementId.substring(4);
                    localStorage.setItem(`lastReadMsg_${currentRoomId}`, lastMessageId);
                }
            }
        });
        
        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
